# Example: Shared sstate-cache and downloads with isolated TMPDIR per build
# This mirrors the proven docker-compose pattern for concurrent Yocto builds.

name: shared-cache-example
description: Example config demonstrating safe concurrent builds with shared caches

yocto_series: kirkstone

base:
  provider: poky
  machine: qemux86-64
  distro: poky
  version: "4.0.20"

# CRITICAL: These directories are SHARED across all builds
# They should point to common locations accessible to all build containers
directories:
  # Shared downloads directory - all builds reuse source tarballs
  downloads: ~/.smidr/downloads

  # Shared sstate-cache - enables massive speedups for repeated builds
  # Store on SSD/NVMe for best performance
  sstate: ~/.smidr/sstate-cache

  # Shared layers directory (read-only mounts into containers)
  layers: ~/.smidr/layers

  # NOTE: build, tmp, and deploy are automatically set per-build by the daemon
  # Each build gets unique paths like:
  #   build: /home/builder/build-{buildID}
  #   tmp: /home/builder/build-{buildID}/tmp
  #   deploy: /home/builder/build-{buildID}/deploy

layers:
  - name: poky
    git: https://git.yoctoproject.org/poky
    branch: kirkstone

  - name: meta-openembedded
    git: https://git.openembedded.org/meta-openembedded
    branch: kirkstone

build:
  image: core-image-minimal
  machine: qemux86-64

  # Tune parallelism per build (adjust for your CPU/memory)
  parallel_make: -j8
  bb_number_threads: 8

container:
  base_image: crops/yocto:ubuntu-22.04-builder

  # Resource limits per build container
  memory: 8g
  cpu_count: 4

# Optional: Advanced tuning
advanced:
  build_timeout: 360  # 6 hours max per build

  # Enable hash equivalence for even better sstate reuse
  # bb_hashserve: "auto"

  # Optional: Use external sstate mirror (saves build time)
  # sstate_mirrors: "file://.* http://sstate-cache.yoctoproject.org/PATH;downloadfilename=PATH"
